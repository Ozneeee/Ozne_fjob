local PlayerData, GUI, CurrentActionData, JobBlips = {}, {}, {}, {}
local HasAlreadyEnteredMarker, publicBlip = false, false
local LastZone, CurrentAction, CurrentActionMsg
ESX = nil
GUI.Time = 0
Citizen.CreateThread(function()	while ESX == nil do TriggerEvent('esx:getSharedObject', function(obj) ESX = obj end) Citizen.Wait(0) end end)
function TeleportFadeEffect(entity, coords) Citizen.CreateThread(function() DoScreenFadeOut(800) while not IsScreenFadedOut() do Citizen.Wait(0) end ESX.Game.Teleport(entity, coords, function() DoScreenFadeIn(800) end) end) end
function OpenCloakroomMenu() ESX.UI.Menu.Open('default', GetCurrentResourceName(), 'cloakroom', { title    = _U('cloakroom'), align    = 'top-left', elements = { {label = _U('vine_clothes_civil'), value = 'citizen_wear'}, {label = _U('vine_clothes_vine'), value = 'ferailleur_wear'}, }, }, function(data, menu) menu.close() if data.current.value == 'citizen_wear' then ESX.TriggerServerCallback('esx_skin:getPlayerSkin', function(skin, jobSkin) TriggerEvent('skinchanger:loadSkin', skin) end) end if data.current.value == 'ferailleur_wear' then ESX.TriggerServerCallback('esx_skin:getPlayerSkin', function(skin, jobSkin) if skin.sex == 0 then local clothesSkin = { ['bags_1'] = 0, ['bags_2'] = 0, ['tshirt_1'] = 15, ['tshirt_2'] = 0, ['torso_1'] = 244, ['torso_2'] = 5, ['arms'] = 28, ['pants_1'] = 98, ['pants_2'] = 0, ['shoes_1'] = 50, ['shoes_2'] = 0, ['mask_1'] = 0, ['mask_2'] = 0, ['bproof_1'] = 0, ['helmet_1'] = -1, ['helmet_2'] = 0, ["decals_1"] = -1, ["decals_2"] = 0, ['chain_1'] = 0, ['chain_2'] = 0 } TriggerEvent('skinchanger:loadClothes', skin, clothesSkin) else local clothesSkinfemale = { ['bags_1'] = 0, ['bags_2'] = 0, ['tshirt_1'] = 15, ['tshirt_2'] = 0, ['torso_1'] = 244, ['torso_2'] = 5, ['arms'] = 28, ['pants_1'] = 98, ['pants_2'] = 0, ['shoes_1'] = 50, ['shoes_2'] = 0, ['mask_1'] = 0, ['mask_2'] = 0, ['bproof_1'] = 0, ['helmet_1'] = -1, ['helmet_2'] = 0, ["decals_1"] = -1, ["decals_2"] = 0, ['chain_1'] = 0, ['chain_2'] = 0 } TriggerEvent('skinchanger:loadClothes', skin, clothesSkinfemale) end end) end CurrentAction     = 'ferailleur_actions_menu' CurrentActionMsg  = _U('open_menu') CurrentActionData = {} end, function(data, menu) menu.close() end) end
function OpenFerailleurActionsMenu() local elements = { {label = _U('cloakroom'), value = 'cloakroom'}, {label = _U('deposit_stock'), value = 'put_stock'} } if Config.EnablePlayerManagement and PlayerData.job ~= nil and (PlayerData.job.grade_name ~= 'recrue' and PlayerData.job.grade_name ~= 'novice')then table.insert(elements, {label = _U('take_stock'), value = 'get_stock'}) end if Config.EnablePlayerManagement and PlayerData.job ~= nil and PlayerData.job.grade_name == 'boss' then table.insert(elements, {label = _U('boss_actions'), value = 'boss_actions'}) end ESX.UI.Menu.CloseAll() ESX.UI.Menu.Open('default', GetCurrentResourceName(), 'ferailleur_actions', { title    = 'ferailleur', align    = 'top-left', elements = elements }, function(data, menu) if data.current.value == 'cloakroom' then OpenCloakroomMenu() end if data.current.value == 'put_stock' then OpenPutStocksMenu() end if data.current.value == 'get_stock' then OpenGetStocksMenu() end if data.current.value == 'boss_actions' then TriggerEvent('esx_society:openBossMenu', 'ferailleur', function(data, menu) menu.close() end) end end, function(data, menu) menu.close() CurrentAction     = 'ferailleur_actions_menu' CurrentActionMsg  = _U('press_to_open') CurrentActionData = {} end) end
function OpenVehicleSpawnerMenu() ESX.UI.Menu.CloseAll() if Config.EnableSocietyOwnedVehicles then local elements = {} ESX.TriggerServerCallback('esx_society:getVehiclesInGarage', function(vehicles) for i=1, #vehicles, 1 do table.insert(elements, {label = GetDisplayNameFromVehicleModel(vehicles[i].model) .. ' [' .. vehicles[i].plate .. ']', value = vehicles[i]}) end ESX.UI.Menu.Open('default', GetCurrentResourceName(), 'vehicle_spawner', { title    = _U('veh_menu'), align    = 'top-left', elements = elements, }, function(data, menu) menu.close() local vehicleProps = data.current.value ESX.Game.SpawnVehicle(vehicleProps.model, Config.Zones.VehicleSpawnPoint.Pos, 320.0, function(vehicle) ESX.Game.SetVehicleProperties(vehicle, vehicleProps) local playerPed = GetPlayerPed(-1) TaskWarpPedIntoVehicle(playerPed,  vehicle,  -1) end) TriggerServerEvent('esx_society:removeVehicleFromGarage', 'ferailleur', vehicleProps) end, function(data, menu) menu.close() CurrentAction     = 'vehicle_spawner_menu' CurrentActionMsg  = _U('spawn_veh') CurrentActionData = {} end) end, 'ferailleur') else local elements = { {label = 'VÃ©hicule de Travail',  value = 'tiptruck'}, {label = 'VÃ©hicule de livraison',  value = 'pounder2'}, } ESX.UI.Menu.Open('default', GetCurrentResourceName(), 'vehicle_spawner', { title    = _U('veh_menu'), align    = 'top-left', elements = elements, }, function(data, menu) menu.close() local model = data.current.value ESX.Game.SpawnVehicle(model, Config.Zones.VehicleSpawnPoint.Pos, 320.326, function(vehicle) local playerPed = GetPlayerPed(-1) TaskWarpPedIntoVehicle(playerPed,  vehicle,  -1) end) end, function(data, menu) menu.close() CurrentAction     = 'vehicle_spawner_menu' CurrentActionMsg  = _U('spawn_veh') CurrentActionData = {} end) end end
function OpenMobileFerailleurActionsMenu() ESX.UI.Menu.CloseAll() ESX.UI.Menu.Open('default', GetCurrentResourceName(), 'mobile_ferailleur_actions', { title    = 'ferailleur', align    = 'top-left', elements = { {label = 'ðŸ“£ Annonce Ouverture ',     value = 'feraille_ouvert'}, {label = 'ðŸ“£ Annonce Fermeture',     value = 'feraille_ferme'}, {label = _U('billing'), value = 'billing'} } }, function(data, menu) if data.current.value == 'billing' then ESX.UI.Menu.Open('dialog', GetCurrentResourceName(), 'billing', { title = _U('invoice_amount') }, function(data, menu) local amount = tonumber(data.value) if amount == nil or amount <= 0 then ESX.ShowNotification(_U('amount_invalid')) else menu.close() local closestPlayer, closestDistance = ESX.Game.GetClosestPlayer() if closestPlayer == -1 or closestDistance > 3.0 then ESX.ShowNotification(_U('no_players_near')) else local playerPed        = GetPlayerPed(-1) Citizen.CreateThread(function() TaskStartScenarioInPlace(playerPed, 'CODE_HUMAN_MEDIC_TIME_OF_DEATH', 0, true) Citizen.Wait(5000) ClearPedTasks(playerPed) TriggerServerEvent('esx_billing:sendBill', GetPlayerServerId(closestPlayer), 'society_ferailleur', 'ferailleur', amount) end) end end end, function(data, menu) menu.close() end) end if data.current.value == 'feraille_ouvert' then TriggerServerEvent('AnnounceFerailleOuvert') end if data.current.value == 'feraille_ferme' then TriggerServerEvent('AnnounceFerailleFerme') end end, function(data, menu) menu.close() end) end
function OpenGetStocksMenu() ESX.TriggerServerCallback('esx_ferailleurjob:getStockItems', function(items) print(json.encode(items)) local elements = {} for i=1, #items, 1 do if (items[i].count ~= 0) then table.insert(elements, {label = 'x' .. items[i].count .. ' ' .. items[i].label, value = items[i].name}) end end ESX.UI.Menu.Open('default', GetCurrentResourceName(), 'stocks_menu', { title    = 'ferailleur Stock', align    = 'top-left', elements = elements }, function(data, menu) local itemName = data.current.value ESX.UI.Menu.Open('dialog', GetCurrentResourceName(), 'stocks_menu_get_item_count', { title = _U('quantity') }, function(data2, menu2) local count = tonumber(data2.value) if count == nil or count <= 0 then ESX.ShowNotification(_U('quantity_invalid')) else menu2.close() menu.close() OpenGetStocksMenu() TriggerServerEvent('esx_ferailleurjob:getStockItem', itemName, count) end end, function(data2, menu2) menu2.close() end) end, function(data, menu) menu.close() end) end) end
function OpenPutStocksMenu() ESX.TriggerServerCallback('esx_ferailleurjob:getPlayerInventory', function(inventory) local elements = {} for i=1, #inventory.items, 1 do local item = inventory.items[i] if item.count > 0 then table.insert(elements, {label = item.label .. ' x' .. item.count, type = 'item_standard', value = item.name}) end end ESX.UI.Menu.Open('default', GetCurrentResourceName(), 'stocks_menu', { title    = _U('inventory'), elements = elements }, function(data, menu) local itemName = data.current.value ESX.UI.Menu.Open('dialog', GetCurrentResourceName(), 'stocks_menu_put_item_count', { title = _U('quantity') }, function(data2, menu2) local count = tonumber(data2.value) if count == nil or count <= 0 then ESX.ShowNotification(_U('quantity_invalid')) else menu2.close() menu.close() OpenPutStocksMenu()		 TriggerServerEvent('esx_ferailleurjob:putStockItems', itemName, count) end end, function(data2, menu2) menu2.close() end) end, function(data, menu) menu.close() end) end) end
RegisterNetEvent('esx:playerLoaded') AddEventHandler('esx:playerLoaded', function(xPlayer) PlayerData = xPlayer blips() end)
RegisterNetEvent('esx:setJob') AddEventHandler('esx:setJob', function(job) PlayerData.job = job deleteBlips() blips() end)
AddEventHandler('esx_ferailleurjob:hasEnteredMarker', function(zone) if zone == 'FerailleFarm' and PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur'  then CurrentAction     = 'raisin_harvest' CurrentActionMsg  = _U('press_collect') CurrentActionData = {zone= zone} end	 if zone == 'TraitementCaro' and PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur'  then CurrentAction     = 'feraille_traitement' CurrentActionMsg  = 'Appuyez sur ~INPUT_CONTEXT~ pour ~y~traiter la ferraille en carrosserie~s~' CurrentActionData = {zone= zone} end			 if zone == 'TraitementKit' and PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur'  then CurrentAction     = 'jus_traitement' CurrentActionMsg  = _U('press_traitement') CurrentActionData = {zone = zone} end if zone == 'TraitementCrochet' and PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur'  then CurrentAction     = 'jus_traitement' CurrentActionMsg  = 'Appuyez sur ~INPUT_CONTEXT~ pour ~y~transformer la ferraille en outil de crochetage~s~' CurrentActionData = {zone = zone} end if zone == 'FerailleurActions' and PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur' then CurrentAction     = 'ferailleur_actions_menu' CurrentActionMsg  = _U('press_to_open') CurrentActionData = {} end if zone == 'VehicleSpawner' and PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur' then CurrentAction     = 'vehicle_spawner_menu' CurrentActionMsg  = _U('spawn_veh') CurrentActionData = {} end	 if zone == 'VehicleDeleter' and PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur' then local playerPed = GetPlayerPed(-1) local coords    = GetEntityCoords(playerPed) if IsPedInAnyVehicle(playerPed,  false) then local vehicle, distance = ESX.Game.GetClosestVehicle({ x = coords.x, y = coords.y, z = coords.z }) if distance ~= -1 and distance <= 1.0 then CurrentAction     = 'delete_vehicle' CurrentActionMsg  = _U('store_veh') CurrentActionData = {vehicle = vehicle} end end end end)
AddEventHandler('esx_ferailleurjob:hasExitedMarker', function(zone) ESX.UI.Menu.CloseAll() if (zone == 'FerailleFarm') and PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur' then TriggerServerEvent('esx_ferailleurjob:stopHarvest') end   if (zone == 'TraitementCaro' or zone == 'TraitementKit' or zone == 'TraitementCrochet') and PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur' then TriggerServerEvent('esx_ferailleurjob:stopTransform') end CurrentAction = nil end)
RegisterNetEvent('esx_phone:loaded') AddEventHandler('esx_phone:loaded', function(phoneNumber, contacts) local specialContact = { name       = 'ferailleur', number     = 'ferailleur', base64Icon = '', } TriggerEvent('esx_phone:addSpecialContact', specialContact.name, specialContact.number, specialContact.base64Icon) end)
function deleteBlips() if JobBlips[1] ~= nil then for i=1, #JobBlips, 1 do RemoveBlip(JobBlips[i]) JobBlips[i] = nil end end end
function blips()	 if PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur' then for k,v in pairs(Config.Zones)do if v.Name == "RÃ©colte de feraille" then local blip2 = AddBlipForCoord(v.Pos.x, v.Pos.y, v.Pos.z) SetBlipSprite (blip2, 271) SetBlipDisplay(blip2, 4) SetBlipScale  (blip2, 0.8) SetBlipColour (blip2, 70) SetBlipAsShortRange(blip2, true) BeginTextCommandSetBlipName('STRING') AddTextComponentString(v.Name) EndTextCommandSetBlipName(blip2) table.insert(JobBlips, blip2) end if v.Name == "Traitement en carrosserie" then local blip2 = AddBlipForCoord(v.Pos.x, v.Pos.y, v.Pos.z) SetBlipSprite (blip2, 271) SetBlipDisplay(blip2, 4) SetBlipScale  (blip2, 0.8) SetBlipColour (blip2, 70) SetBlipAsShortRange(blip2, true) BeginTextCommandSetBlipName('STRING') AddTextComponentString(v.Name) EndTextCommandSetBlipName(blip2) table.insert(JobBlips, blip2) end if v.Name == "Traitement en kit de rÃ©parations" then local blip2 = AddBlipForCoord(v.Pos.x, v.Pos.y, v.Pos.z) SetBlipSprite (blip2, 271) SetBlipDisplay(blip2, 4) SetBlipScale  (blip2, 0.8) SetBlipColour (blip2, 70) SetBlipAsShortRange(blip2, true) BeginTextCommandSetBlipName('STRING') AddTextComponentString(v.Name) EndTextCommandSetBlipName(blip2) table.insert(JobBlips, blip2) end if v.Name == "Traitement en outil de crochetage" then local blip2 = AddBlipForCoord(v.Pos.x, v.Pos.y, v.Pos.z) SetBlipSprite (blip2, 271) SetBlipDisplay(blip2, 4) SetBlipScale  (blip2, 0.8) SetBlipColour (blip2, 70) SetBlipAsShortRange(blip2, true) BeginTextCommandSetBlipName('STRING') AddTextComponentString(v.Name) EndTextCommandSetBlipName(blip2) table.insert(JobBlips, blip2) end end end end
Citizen.CreateThread(function() while true do Wait(0) local coords = GetEntityCoords(GetPlayerPed(-1)) for k,v in pairs(Config.Zones) do if PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur' then if(v.Type ~= -1 and GetDistanceBetweenCoords(coords, v.Pos.x, v.Pos.y, v.Pos.z, true) < Config.DrawDistance) then DrawMarker(v.Type, v.Pos.x, v.Pos.y, v.Pos.z, 0.0, 0.0, 0.0, 0, 0.0, 0.0, v.Size.x, v.Size.y, v.Size.z, v.Color.r, v.Color.g, v.Color.b, 100, false, true, 2, false, false, false, false) end end end end end)
Citizen.CreateThread(function() while true do Wait(0) if PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur' then local coords      = GetEntityCoords(GetPlayerPed(-1)) local isInMarker  = false local currentZone = nil for k,v in pairs(Config.Zones) do if(GetDistanceBetweenCoords(coords, v.Pos.x, v.Pos.y, v.Pos.z, true) < v.Size.x) then isInMarker  = true currentZone = k end end if (isInMarker and not HasAlreadyEnteredMarker) or (isInMarker and LastZone ~= currentZone) then HasAlreadyEnteredMarker = true LastZone                = currentZone TriggerEvent('esx_ferailleurjob:hasEnteredMarker', currentZone) end if not isInMarker and HasAlreadyEnteredMarker then HasAlreadyEnteredMarker = false TriggerEvent('esx_ferailleurjob:hasExitedMarker', LastZone) end end end end)
RegisterNetEvent('ozne_useitem:onFixkit') AddEventHandler('ozne_useitem:onFixkit', function() local playerPed = PlayerPedId() local coords    = GetEntityCoords(playerPed) if IsAnyVehicleNearPoint(coords.x, coords.y, coords.z, 5.0) then local vehicle if IsPedInAnyVehicle(playerPed, false) then vehicle = GetVehiclePedIsIn(playerPed, false) else vehicle = GetClosestVehicle(coords.x, coords.y, coords.z, 5.0, 0, 71) end if DoesEntityExist(vehicle) then TaskStartScenarioInPlace(playerPed, 'PROP_HUMAN_BUM_BIN', 0, true) Citizen.CreateThread(function() Citizen.Wait(20000) SetVehicleFixed(vehicle) SetVehicleDeformationFixed(vehicle) SetVehicleUndriveable(vehicle, false) ClearPedTasksImmediately(playerPed) ESX.ShowNotification('~g~VÃ©hicule rÃ©parÃ©') end) end end end)
RegisterNetEvent('ozne_useitem:onCarokit') AddEventHandler('ozne_useitem:onCarokit', function() local playerPed = PlayerPedId() local coords    = GetEntityCoords(playerPed) if IsAnyVehicleNearPoint(coords.x, coords.y, coords.z, 5.0) then local vehicle if IsPedInAnyVehicle(playerPed, false) then vehicle = GetVehiclePedIsIn(playerPed, false) else vehicle = GetClosestVehicle(coords.x, coords.y, coords.z, 5.0, 0, 71) end if DoesEntityExist(vehicle) then TaskStartScenarioInPlace(playerPed, 'WORLD_HUMAN_HAMMERING', 0, true) Citizen.CreateThread(function() Citizen.Wait(10000) SetVehicleFixed(vehicle) SetVehicleDeformationFixed(vehicle) ClearPedTasksImmediately(playerPed) ESX.ShowNotification('~g~Carosserie rÃ©parÃ©e') end) end end end)
Citizen.CreateThread(function() while true do Citizen.Wait(0) if CurrentAction ~= nil then SetTextComponentFormat('STRING') AddTextComponentString(CurrentActionMsg) DisplayHelpTextFromStringLabel(0, 0, 1, -1) if IsControlPressed(0,  38) and PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur' and (GetGameTimer() - GUI.Time) > 300 then if CurrentAction == 'raisin_harvest' then 	TriggerServerEvent('esx_ferailleurjob:startHarvest', CurrentActionData.zone) end if CurrentAction == 'jus_traitement' then 	TriggerServerEvent('esx_ferailleurjob:startTransform', CurrentActionData.zone) end if CurrentAction == 'feraille_traitement' then 	TriggerServerEvent('esx_ferailleurjob:startTransform', CurrentActionData.zone) end if CurrentAction == 'ferailleur_actions_menu' then 	OpenFerailleurActionsMenu() end if CurrentAction == 'vehicle_spawner_menu' then 	OpenVehicleSpawnerMenu() end if CurrentAction == 'delete_vehicle' then if Config.EnableSocietyOwnedVehicles then local vehicleProps = ESX.Game.GetVehicleProperties(CurrentActionData.vehicle) TriggerServerEvent('esx_society:putVehicleInGarage', 'ferailleur', vehicleProps) end ESX.Game.DeleteVehicle(CurrentActionData.vehicle) end CurrentAction = nil GUI.Time      = GetGameTimer() end end if IsControlPressed(0,  167) and Config.EnablePlayerManagement and PlayerData.job ~= nil and PlayerData.job.name == 'ferailleur' and (GetGameTimer() - GUI.Time) > 150 then OpenMobileFerailleurActionsMenu() GUI.Time = GetGameTimer() end end end)
Citizen.CreateThread(function() for i=1, #Config.Map, 1 do local blipqg = AddBlipForCoord(Config.Map[i].x, Config.Map[i].y, Config.Map[i].z) SetBlipSprite (blipqg, Config.Map[i].id) SetBlipDisplay(blipqg, 4) SetBlipColour (blipqg, Config.Map[i].color) SetBlipScale (blipqg, Config.Map[i].scale) SetBlipAsShortRange(blipqg, true) BeginTextCommandSetBlipName("STRING") AddTextComponentString(Config.Map[i].name) EndTextCommandSetBlipName(blipqg) end end)
